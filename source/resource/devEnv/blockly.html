<html>
  <head>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  </head>

  <body>
    <div id="blocklyDiv" style="height: 100%; width: 100%;"></div>

    <xml id="blocklyToolbox" xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
      <category name="Logic" colour="#5b80a5">
        <block type="controls_if"></block>
        <block type="logic_compare">
          <field name="OP">EQ</field>
        </block>
        <block type="logic_operation">
          <field name="OP">AND</field>
        </block>
        <block type="logic_negate"></block>
        <block type="logic_boolean">
          <field name="BOOL">TRUE</field>
        </block>
        <block type="logic_null"></block>
        <block type="logic_ternary"></block>
      </category>
      <category name="Loops" colour="#5ba55b">
        <block type="controls_repeat_ext">
          <value name="TIMES">
            <shadow type="math_number">
              <field name="NUM">10</field>
            </shadow>
          </value>
        </block>
        <block type="controls_whileUntil">
          <field name="MODE">WHILE</field>
        </block>
        <block type="controls_for">
          <field name="VAR" id="??MNIGw}$wi-^=VBf:8o">i</field>
          <value name="FROM">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="TO">
            <shadow type="math_number">
              <field name="NUM">10</field>
            </shadow>
          </value>
          <value name="BY">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
        </block>
        <block type="controls_forEach">
          <field name="VAR" id="|,H4}2ERbeyxlpRqH^IZ">j</field>
        </block>
        <block type="controls_flow_statements">
          <field name="FLOW">BREAK</field>
        </block>
      </category>
      <category name="Math" colour="#5b67a5">
        <block type="math_number">
          <field name="NUM">0</field>
        </block>
        <block type="math_arithmetic">
          <field name="OP">ADD</field>
          <value name="A">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="B">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
        </block>
        <block type="math_single">
          <field name="OP">ROOT</field>
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">9</field>
            </shadow>
          </value>
        </block>
        <block type="math_trig">
          <field name="OP">SIN</field>
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">45</field>
            </shadow>
          </value>
        </block>
        <block type="math_constant">
          <field name="CONSTANT">PI</field>
        </block>
        <block type="math_number_property">
          <mutation divisor_input="false"></mutation>
          <field name="PROPERTY">EVEN</field>
          <value name="NUMBER_TO_CHECK">
            <shadow type="math_number">
              <field name="NUM">0</field>
            </shadow>
          </value>
        </block>
        <block type="math_round">
          <field name="OP">ROUND</field>
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">3.1</field>
            </shadow>
          </value>
        </block>
        <block type="math_on_list">
          <mutation op="SUM"></mutation>
          <field name="OP">SUM</field>
        </block>
        <block type="math_modulo">
          <value name="DIVIDEND">
            <shadow type="math_number">
              <field name="NUM">64</field>
            </shadow>
          </value>
          <value name="DIVISOR">
            <shadow type="math_number">
              <field name="NUM">10</field>
            </shadow>
          </value>
        </block>
        <block type="math_constrain">
          <value name="VALUE">
            <shadow type="math_number">
              <field name="NUM">50</field>
            </shadow>
          </value>
          <value name="LOW">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="HIGH">
            <shadow type="math_number">
              <field name="NUM">100</field>
            </shadow>
          </value>
        </block>
        <block type="math_random_int">
          <value name="FROM">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
          <value name="TO">
            <shadow type="math_number">
              <field name="NUM">100</field>
            </shadow>
          </value>
        </block>
        <block type="math_random_float"></block>
      </category>
      <category name="Text" colour="#5ba58c">
        <block type="text">
          <field name="TEXT"></field>
        </block>
        <block type="text_join">
          <mutation items="2"></mutation>
        </block>
        <block type="text_append">
          <field name="VAR" id="U-52AYxrarrY@0+q0teO">item</field>
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT"></field>
            </shadow>
          </value>
        </block>
        <block type="text_length">
          <value name="VALUE">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_isEmpty">
          <value name="VALUE">
            <shadow type="text">
              <field name="TEXT"></field>
            </shadow>
          </value>
        </block>
        <block type="text_indexOf">
          <field name="END">FIRST</field>
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR" id="~.I^Za`bFDH3wsa=X*J4">text</field>
            </block>
          </value>
          <value name="FIND">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_charAt">
          <mutation at="true"></mutation>
          <field name="WHERE">FROM_START</field>
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR" id="~.I^Za`bFDH3wsa=X*J4">text</field>
            </block>
          </value>
        </block>
        <block type="text_getSubstring">
          <mutation at1="true" at2="true"></mutation>
          <field name="WHERE1">FROM_START</field>
          <field name="WHERE2">FROM_START</field>
          <value name="STRING">
            <block type="variables_get">
              <field name="VAR" id="~.I^Za`bFDH3wsa=X*J4">text</field>
            </block>
          </value>
        </block>
        <block type="text_changeCase">
          <field name="CASE">UPPERCASE</field>
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_trim">
          <field name="MODE">BOTH</field>
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_print">
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
        <block type="text_prompt_ext">
          <mutation type="TEXT"></mutation>
          <field name="TYPE">TEXT</field>
          <value name="TEXT">
            <shadow type="text">
              <field name="TEXT">abc</field>
            </shadow>
          </value>
        </block>
      </category>
<!--
      <category name="Lists" colour="#745ba5">
        <block type="lists_create_with">
          <mutation items="0"></mutation>
        </block>
        <block type="lists_create_with">
          <mutation items="3"></mutation>
        </block>
        <block type="lists_repeat">
          <value name="NUM">
            <shadow type="math_number">
              <field name="NUM">5</field>
            </shadow>
          </value>
        </block>
        <block type="lists_length"></block>
        <block type="lists_isEmpty"></block>
        <block type="lists_indexOf">
          <field name="END">FIRST</field>
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR" id="Jm,HOiLJ-p,[8}HZ[xe_">list</field>
            </block>
          </value>
        </block>
        <block type="lists_getIndex">
          <mutation statement="false" at="true"></mutation>
          <field name="MODE">GET</field>
          <field name="WHERE">FROM_START</field>
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR" id="Jm,HOiLJ-p,[8}HZ[xe_">list</field>
            </block>
          </value>
        </block>
        <block type="lists_setIndex">
          <mutation at="true"></mutation>
          <field name="MODE">SET</field>
          <field name="WHERE">FROM_START</field>
          <value name="LIST">
            <block type="variables_get">
              <field name="VAR" id="Jm,HOiLJ-p,[8}HZ[xe_">list</field>
            </block>
          </value>
        </block>
        <block type="lists_getSublist">
          <mutation at1="true" at2="true"></mutation>
          <field name="WHERE1">FROM_START</field>
          <field name="WHERE2">FROM_START</field>
          <value name="LIST">
            <block type="variables_get">
              <field name="VAR" id="Jm,HOiLJ-p,[8}HZ[xe_">list</field>
            </block>
          </value>
        </block>
        <block type="lists_split">
          <mutation mode="SPLIT"></mutation>
          <field name="MODE">SPLIT</field>
          <value name="DELIM">
            <shadow type="text">
              <field name="TEXT">,</field>
            </shadow>
          </value>
        </block>
        <block type="lists_sort">
          <field name="TYPE">NUMERIC</field>
          <field name="DIRECTION">1</field>
        </block>
      </category>
      <category name="Colour" colour="#a5745b">
        <block type="colour_picker">
          <field name="COLOUR">#ff0000</field>
        </block>
        <block type="colour_random"></block>
        <block type="colour_rgb">
          <value name="RED">
            <shadow type="math_number">
              <field name="NUM">100</field>
            </shadow>
          </value>
          <value name="GREEN">
            <shadow type="math_number">
              <field name="NUM">50</field>
            </shadow>
          </value>
          <value name="BLUE">
            <shadow type="math_number">
              <field name="NUM">0</field>
            </shadow>
          </value>
        </block>
        <block type="colour_blend">
          <value name="COLOUR1">
            <shadow type="colour_picker">
              <field name="COLOUR">#ff0000</field>
            </shadow>
          </value>
          <value name="COLOUR2">
            <shadow type="colour_picker">
              <field name="COLOUR">#3333ff</field>
            </shadow>
          </value>
          <value name="RATIO">
            <shadow type="math_number">
              <field name="NUM">0.5</field>
            </shadow>
          </value>
        </block>
      </category>
-->
      <sep></sep>
      <category name="Variables" colour="#a55b80" custom="VARIABLE"></category>
      <category name="Functions" colour="#995ba5" custom="PROCEDURE"></category>
      <sep></sep>
      <category name="Elevator" colour="#9fa55b">
        <block type="access_elevator_motor_controller">
        </block>
        <block type="access_elevator_encoder">
        </block>
        <block type="access_elevator_button">
        </block>
        <block type="access_elevator_floor_sensor">
        </block>
        <block type="elevator_motor_controller_getter">
          <field name="method">getEncoder</field>
        </block>
        <block type="elevator_button">
          <field name="id">up</field>
          <field name="method">isPressed</field>
        </block>
        <block type="elevator_floor_sensor">
          <field name="id">1B</field>
          <field name="method">isActivated</field>
        </block>
        <block type="elevator_motor_controller_setter">
          <field name="NAME">setVelocity</field>
          <field name="velocity">0</field>
        </block>
      </category>
    </xml>


    <script>
      Blockly.defineBlocksWithJsonArray(
      [
        {
          "type": "access_elevator_motor_controller",
          "message0": "Connect to Elevator Motor Controller",
          "previousStatement": null,
          "nextStatement": null,
          "colour": 60,
          "tooltip": "",
          "helpUrl": ""
        },
        {
          "type": "access_elevator_encoder",
          "message0": "Connect to Elevator Encoder",
          "previousStatement": null,
          "nextStatement": null,
          "colour": 60,
          "tooltip": "",
          "helpUrl": ""
        },
        {
          "type": "access_elevator_button",
          "message0": "Connect to Elevator Button: %1",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "button",
              "options": [
                [
                  "Up",
                  "Up"
                ],
                [
                  "Down",
                  "Down"
                ],
                [
                  "1",
                  "1"
                ],
                [
                  "2",
                  "2"
                ],
                [
                  "3",
                  "3"
                ]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 60,
          "tooltip": "",
          "helpUrl": ""
        },
        {
          "type": "access_elevator_floor_sensor",
          "message0": "Connect to Elevator Sensor at %1",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "sensor",
              "options": [
                [
                  "Floor 1 Bottom",
                  "1B"
                ],
                [
                  "Floor 1 Top",
                  "1T"
                ],
                [
                  "Floor 2 Bottom",
                  "2B"
                ],
                [
                  "Floor 2 Top",
                  "2T"
                ],
                [
                  "Floor 3 Bottom",
                  "3B"
                ],
                [
                  "Floor 3 Top",
                  "3T"
                ]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 60,
          "tooltip": "",
          "helpUrl": ""
        },
        {
          "type": "elevator_motor_controller_getter",
          "message0": "with Elevator Motor Controller %1",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "method",
              "options": [
                [
                  "get encoder value",
                  "getEncoder"
                ],
                [
                  "get velocity",
                  "getVelocity"
                ]
              ]
            }
          ],
          "output": "Number",
          "colour": 60,
          "tooltip": "",
          "helpUrl": ""
        },
        {
          "type": "elevator_motor_controller_setter",
          "message0": "with Elevator Motor Controller %1 to %2",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "NAME",
              "options": [
                [
                  "set velocity",
                  "setVelocity"
                ]
              ]
            },
            {
              "type": "field_number",
              "name": "velocity",
              "value": 0,
              "min": -100,
              "max": 100
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 60,
          "tooltip": "",
          "helpUrl": ""
        },
        {
          "type": "elevator_button",
          "message0": "with Elevator Button %1 get %2",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "id",
              "options": [
                [
                  "Up",
                  "Up"
                ],
                [
                  "Down",
                  "Down"
                ],
                [
                  "1",
                  "1"
                ],
                [
                  "2",
                  "2"
                ],
                [
                  "3",
                  "3"
                ]
              ]
            },
            {
              "type": "field_dropdown",
              "name": "method",
              "options": [
                [
                  "is pressed",
                  "isPressed"
                ]
              ]
            }
          ],
          "output": "Boolean",
          "colour": 60,
          "tooltip": "Returns true if the button is pressed; false otherwise",
          "helpUrl": ""
        },
        {
          "type": "elevator_floor_sensor",
          "message0": "with Elevator Sensor %1 get %2",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "id",
              "options": [
                [
                  "Floor 1 Bottom",
                  "1B"
                ],
                [
                  "Floor 1 Top",
                  "1T"
                ],
                [
                  "Floor 2 Bottom",
                  "2B"
                ],
                [
                  "Floor 2 Top",
                  "2T"
                ],
                [
                  "Floor 3 Bottom",
                  "3B"
                ],
                [
                  "Floor 3 Top",
                  "3T"
                ]
              ]
            },
            {
              "type": "field_dropdown",
              "name": "method",
              "options": [
                [
                  "is activated",
                  "isActivated"
                ]
              ]
            }
          ],
          "output": "Boolean",
          "colour": 60,
          "tooltip": "Returns true if the sensor has been activated; false otherwise",
          "helpUrl": ""
        }
      ]);
    </script>

    <script>
    // Overwrite the default text_print block's code which calls
    // `alert`. Instead, write to the console.
    Blockly.JavaScript['text_print'] = function(block) {
      {
        let code =
            "console.log(" +
            (Blockly.JavaScript.valueToCode(
              block, "TEXT", Blockly.JavaScript.ORDER_NONE) || "''") +
            ");\n"
        return code;
      }
    };

    Blockly.JavaScript['access_elevator_motor_controller'] = function(block) {
      {
        let code = "elevatorSim.Elevator.getInstance().show();";

        return code;
      }
    };

    Blockly.JavaScript['access_elevator_encoder'] = function(block) {
      {
        let code = "elevatorSim.Elevator.getInstance().allowAccessEncoder();";

        return code;
      }
    };

    Blockly.JavaScript['access_elevator_button'] = function(block) {
      {
        let button = block.getFieldValue("button");
        let code =
          `elevatorSim.Elevator.getInstance().allowAccessButton("${button}");`;

        return code;
      }
    };

    Blockly.JavaScript['access_elevator_floor_sensor'] = function(block) {
      {
        let sensor = block.getFieldValue("sensor");
        let code =
          `elevatorSim.Elevator.getInstance().allowAccessFloorSensor("${sensor}");`;

        return code;
      }
    };

    Blockly.JavaScript['elevator_motor_controller_getter'] = function(block) {
      {
        let code;
        let method = block.getFieldValue('method');

        switch(method)
        {
        case "getVelocity" :
          code = "elevatorSim.Elevator.getInstance().getVelocity()"
          break;

        case "getEncoder" :
          code = "elevatorSim.Elevator.getInstance().getEncoder()"
          break;
        }

        return [code, Blockly.JavaScript.ORDER_NONE];
      }
    };

    Blockly.JavaScript['elevator_motor_controller_setter'] = function(block) {
      let             code;
      let             velocity = block.getFieldValue('velocity');

      code = `elevatorSim.Elevator.getInstance().setVelocity(${velocity});\n`;
      return code;
    };

    Blockly.JavaScript['elevator_button'] = function(block) {
      let             code;
      let             id = block.getFieldValue('id');
      let             method = block.getFieldValue('method'); // isPressed

      code = `elevatorSim.Elevator.getInstance().isButtonPressed("${id}")`;

      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['elevator_floor_sensor'] = function(block) {
      let             code;
      let             id = block.getFieldValue('id');
      let             method = block.getFieldValue('method'); // isPressed

      code = `elevatorSim.Elevator.getInstance().isFloorSensorActive("${id}")`;

      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    </script>

    <script>
      var workspace =
          Blockly.inject(
            "blocklyDiv",
            {
              toolbox: document.getElementById("blocklyToolbox")
            });

      // Disable any orphans
      workspace.addChangeListener(Blockly.Events.disableOrphans);

      // Await any changes, so we can save them
      workspace.addChangeListener(
        (event) =>
        {
          let             code;

          switch(event.type)
          {
          case Blockly.Events.BLOCK_CREATE :
          case Blockly.Events.BLOCK_DELETE :
          case Blockly.Events.BLOCK_CHANGE :
          case Blockly.Events.BLOCK_MOVE :
            // Retrieve the workspace as XML
            code = Blockly.Xml.workspaceToDom(workspace);
            code = (new XMLSerializer()).serializeToString(code);

            // Save it in local storage
            window.localStorage.setItem("code_xml", code);

            // Avoid confusion: disable the simulation whenever a change is made
            window.parent.postMessage(
              {
                type  : "control",
                name  : "setEnabled",
                value : false
              },
              "*");

            break;

          default :
            break;
          }
        });

      console.clear();

      // Create the two permanent blocks
      var xml = window.localStorage.getItem("code_xml");
      if (! xml)
      {
        xml =
            [
              "<xml>",
              "  <block type='procedures_defnoreturn' ",
              "      deletable='false' movable='false' x='10' y='10'>",
              "    <field name='NAME'>do initially</field>",
              "    <comment pinned='false' h='80' w='400'>This function is called once each time the elevator simulation is enabled.</comment>",
              "  </block>",
              "",
              "  <block type='procedures_defnoreturn' ",
              "      deletable='false' movable='false' x='400' y='10'>",
              "    <field name='NAME'>do periodically</field>",
              "    <comment pinned='false' h='120' w='400'>This function is called after `do initially`, once every 50ms, i.e., 20 times per second, while the elevator simulation is enabled.</comment>",
              "  </block>",
              "</xml>"
            ].join("");
      }
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), workspace);

      window.addEventListener(
        "message",
        (event) =>
        {
          let             code;

          switch(event.data.type)
          {
          case "control" :
            switch(event.data.name)
            {
            case "enabled" :
              // Only generate code when enabling, not when disabling
              if (! event.data.value)
              {
                return;
              }

              // code = Blockly.Xml.workspaceToDom(workspace);
              // console.log("workspace: ", code);

              // Generate code from the blocks
              code = Blockly.JavaScript.workspaceToCode(workspace);
              // console.log("code: " + code);
              window.parent.postMessage(
                {
                  type  : "control",
                  name  : "run",
                  value : code
                },
                "*");
              break;
            }
            break;

          case "load" :
            code = event.data.value;
            Blockly.Xml.clearWorkspaceAndLoadFromXml(
              Blockly.Xml.textToDom(code),
              workspace);
            break;
          }
        });
      // window.parent.postMessage("hello world", "*");
    </script>
  </body>
</html>
